<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ name }} - SVG 展示</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/crt.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cards.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/view_svg.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}">
</head>
<body class="min-h-screen font-mono">
<nav class="banner">
    <a href="{{ url_for('vps_list') }}" class="banner-home">
        <div class="banner-title">
            ⚡ <span>VPS</span> <span>剩余价值计算器</span>
        </div>
        <div class="banner-stats">
            在用主机：<strong>{{ site_stats.count }} 台</strong> / 总价值：<strong>{{ site_stats.total_value }} 元</strong>
        </div>
    </a>
    <div class="banner-subinfo">
        {% if current_user %}
        <span>你好, {{ current_user.username }}</span>
        <a class="text-sm border border-cyan-400 hover:bg-cyan-600 text-cyan-200 hover:text-white px-3 py-1 rounded transition" href="{{ url_for('add_vps') }}">添加 VPS</a>
        <a class="text-sm border border-cyan-400 hover:bg-cyan-600 text-cyan-200 hover:text-white px-3 py-1 rounded transition" href="{{ url_for('manage_vps') }}">管理 VPS</a>
        {% if current_user.is_admin %}
        <a class="text-sm border border-cyan-400 hover:bg-cyan-600 text-cyan-200 hover:text-white px-3 py-1 rounded transition" href="{{ url_for('manage_users') }}">用户管理</a>
        {% endif %}
        <a class="text-sm border border-cyan-400 hover:bg-cyan-600 text-cyan-200 hover:text-white px-3 py-1 rounded transition" href="{{ url_for('logout') }}">退出登录</a>
        {% else %}
        <a class="text-sm border border-cyan-400 hover:bg-cyan-600 text-cyan-200 hover:text-white px-3 py-1 rounded transition" href="{{ url_for('login') }}">登录</a>
        <a class="text-sm border border-cyan-400 hover:bg-cyan-600 text-cyan-200 hover:text-white px-3 py-1 rounded transition" href="{{ url_for('register') }}">注册</a>
        {% endif %}
    </div>
</nav>
<div class="card-container">
    <div class="svg-card">
        <h2 class="text-center text-cyan-300 text-xl mb-4 font-bold">{{ vps.name }}</h2>
        <div class="vps-info-grid">
            <div class="label">商家</div><div>：</div><div>{{ vps.vendor_name or '-' }}</div>
            <div class="label">配置</div><div>：</div><div>{{ specs.cpu }} / {{ specs.memory }} / {{ specs.storage }}</div>
            <div class="label">月流量</div><div>：</div><div>{{ vps.traffic_limit or '-' }}</div>
            <div class="label">IP 地址</div><div>：</div><div class="ip-address">{{ ip_info.flag|twemoji }} {{ ip_info.ip_display }}</div>
            <div class="label">在线状态</div><div>：</div><div><span class="ping-status" data-ip="{{ vps.ip_address }}">{{ ip_info.ping_status }}</span></div>
            <div class="label">到期时间</div><div>：</div><div>{{ data.cycle_end.strftime('%Y/%m/%d') if data.cycle_end else '-' }}</div>
            <div class="label">续费金额</div><div>：</div><div>{{ vps.renewal_price or '-' }} {{ vps.currency }}</div>
            {% if vps.status == 'forsale' %}
            <div class="label">转让溢价</div><div>：</div><div>{{ vps.sale_percent }}%</div>
            <div class="label">固定溢价</div><div>：</div><div>{{ vps.sale_fixed }} 元</div>
            <div class="label">Push 费用</div><div>：</div><div>{{ data.push_fee_cny }} 元</div>
            <div class="label">最终价格</div><div>：</div><div>{{ data.final_price }} 元</div>
            {% endif %}
            <div class="label">描述说明</div><div>：</div><div>{{ vps.description or '-' }}</div>
        </div>
        <div class="vps-card-footer">
            <div class="left-info">
                <div>剩余天数：{{ data.remaining_days }} 天</div>
                <div>剩余价值：{{ data.remaining_value }} 元</div>
                {% if vps.status == 'forsale' %}
                <div>最终价格：{{ data.final_price }} 元</div>
                {% endif %}
            </div>
            <div class="right-info">
                <div>更新时间：{{ today.strftime('%Y/%m/%d') }}</div>
                <div>NodeSeekID：{{ config.username if config and config.username else '' }}</div>
            </div>
        </div>
        <div class="card-buttons">
            <a href="{{ url_for('vps_list') }}">返回列表</a>
            <button id="copyLinkBtn">复制一键发帖</button>
            <a href="{{ url_for('edit_vps', vps_id=vps_id) }}">编辑此项</a>
        </div>
    </div>
</div>
<script>
    function updatePingStatus() {
        document.querySelectorAll('.ping-status').forEach(el => {
            const ip = el.dataset.ip;
            fetch(`/ping/${ip}`).then(r => r.text()).then(t => {
                el.textContent = t;
            });
        });
    }
    updatePingStatus();
    setInterval(updatePingStatus, 60000);

    document.getElementById('copyLinkBtn').addEventListener('click', function () {
        const rawUrl = {{ svg_abs_url|tojson }};
        const url = encodeURI(rawUrl);

        const vendor = {{ (vps.vendor_name or '-')|tojson }};
        const specsText = {{ (specs.cpu + ' / ' + specs.memory + ' / ' + specs.storage)|tojson }};
        const machineName = {{ vps.name|tojson }};

        const lines = [];
        lines.push(`出手${vendor} ${specsText}的${machineName}机器`);

        document.querySelectorAll('.vps-info-grid .label').forEach(label => {
            const value = label.nextElementSibling.nextElementSibling.textContent.trim();
            lines.push(`${label.textContent}：${value}`);
        });

        document.querySelectorAll('.left-info div, .right-info div').forEach(div => {
            lines.push(div.textContent.trim());
        });

        lines.push(`![image](${url})`);
        const text = lines.join('\n');

        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => {
                alert('发帖内容已复制');
            }).catch(() => {
                fallbackCopyText(text);
            });
        } else {
            fallbackCopyText(text);
        }
    });

    function fallbackCopyText(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            if (document.execCommand('copy')) {
                alert('发帖内容已复制');
            } else {
                throw new Error('copy failed');
            }
        } catch (err) {
            alert('复制失败，请手动复制。');
        }
        document.body.removeChild(textArea);
    }
</script>
{% include 'footer.html' %}
</body>
</html>
